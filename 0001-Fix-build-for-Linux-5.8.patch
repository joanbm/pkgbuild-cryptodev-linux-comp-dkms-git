From e7506712165619eedd5478449ab1afe4dcbaf71e Mon Sep 17 00:00:00 2001
From: Joan Bruguera <joanbrugueram@gmail.com>
Date: Sat, 13 Jun 2020 19:46:44 +0200
Subject: [PATCH] Fix build for Linux 5.8

See also: https://github.com/torvalds/linux/commit/d8ed45c5dcd455fc5848d47f86883a1b872ac0d0
---
 zc.c | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/zc.c b/zc.c
index ae464ff..2c286bb 100644
--- a/zc.c
+++ b/zc.c
@@ -58,7 +58,11 @@ int __get_userbuf(uint8_t __user *addr, uint32_t len, int write,
 		return 0;
 	}
 
+#if (LINUX_VERSION_CODE < KERNEL_VERSION(5, 8, 0))
 	down_read(&mm->mmap_sem);
+#else
+	mmap_read_lock(mm);
+#endif
 #if (LINUX_VERSION_CODE < KERNEL_VERSION(4, 6, 0))
 	ret = get_user_pages(task, mm,
 			(unsigned long)addr, pgcount, write, 0, pg, NULL);
@@ -74,7 +78,11 @@ int __get_userbuf(uint8_t __user *addr, uint32_t len, int write,
 			(unsigned long)addr, pgcount, write ? FOLL_WRITE : 0,
 			pg, NULL, NULL);
 #endif
+#if (LINUX_VERSION_CODE < KERNEL_VERSION(5, 8, 0))
 	up_read(&mm->mmap_sem);
+#else
+	mmap_read_unlock(mm);
+#endif
 	if (ret != pgcount)
 		return -EINVAL;
 
-- 
2.27.0

